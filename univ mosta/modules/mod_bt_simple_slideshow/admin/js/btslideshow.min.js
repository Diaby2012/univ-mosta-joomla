(function($){
	
    $.fn.BtGallery = function(options){

        this.options = options;
        this.initialize = function(){

            var a=this.options.encodedItems;
            var c=this;
           
            if(a!=null){
                for(var i = 0; i< a.length; i++){
                    c.add(a[i]);
                }
            }
            var d=null;
            if(typeof document.adminForm.onsubmit=="function"){
                d=document.adminForm.onsubmit
            }
            document.adminForm.onsubmit=function(){
                var e=[];
                var f=0;
                $("#btss-gallery-container li").each(function(){
                    var h=$(this).data("item");
                    if(h!=null){
                        e[f]=h;
                        f++
                    }
                });
				
                $("#btss-gallery-hidden").val($.toJSON(e));
				
                if(d!=null){
                    d()
                }
				return false;
            }
        }
        this.add = function(d, tmp){
		
			var videoicon = '<div class="videoIcon"></div>';
			var b = $('<li>').html('<img src="'+this.options.liveUrl + (tmp ? "/tmp" : "" ) +"/manager/"+d.file+'" /><a href="javascript:void(0)" class="edit">Edit</a><a href="javascript:void(0)" class="remove">Remove</a>');

            var c=this;
            b.find(".edit").on("click",function(){
                c.edit(b)
            });
            b.find(".remove").on("click",function(){
                c.remove(b)
            });
            b.data("item",d);
            var a=$(this.options.galleryContainer);
            b.hide();
            a.append(b);
            b.fadeIn(300);
        }
        this.edit = function(b){
			var a = $(this.options.dialogTemplate);
			
            var c=b.data("item");
            a.find(".btss-title").val(c.title);
            a.find(".btss-link").val(c.link);
            a.find(".btss-target").val(c.target);					
            a.find(".btss-desc").val(c.desc);
			
            a.find(".btss-dialog-ok").on("click",function(){
                c.title=a.find(".btss-title").val();
                c.link=a.find(".btss-link").val();
                c.target = a.find(".btss-target").val();             
                c.desc=a.find(".btss-desc").val();
                b.data("item",c);
                a.dialog('close');
            });
            a.find(".btss-dialog-cancel").on("click",function(){
                a.dialog('close');
            });
			
            a.dialog({
				width: 450,
				height:350,
				closeText: ''
				
			});
        }
        this.remove = function(a){
            
            var img = a.find('img').attr('src').split('/');
			var file = img[img.length - 1];
            var c = this;
            $.ajax({
                url: location.href,
                data: "action=delete&id="+ this.options.moduleID + "&file="+file,
                type: "post",
                dataType: "json",
                success: function(data){
                    if (!data.success) {
                        c.showMessage("#btss-message", "<b>Failed to delete images </b> - " + data.message);
                    }
                    else {
						a.hide(300, function(){
							$(this).remove();
						});
                        
                        c.showMessage("#btss-message", "<b>Deleted images successfully</b>");
                    }
                },
                complete: function(){
                    c.removeLog();
                },
                error: function(jqXHR, textStatus, errorThrown){
                    c.showMessage("#btss-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                    c.removeLog();
                }
        
            })
        }
       this.removeAll = function(){
            var a = $(this.options.galleryContainer);
            var b = a.find("li");
            var c = this;
            var success = true;
            b.each(function(){
				var d = $(this);
			    var img = d.find('img').attr('src').split('/');
				var file = img[img.length - 1];
                $.ajax({
                    url: location.href,
                    data: "action=delete&id="+ c.options.moduleID + "&file="+ file,
                    type: "post",
					dataType : "json",
                    success: function(data){
                        if (!data.success) {
                            success = false;
                        }
                        else {
                            d.hide(300, function(){
								$(this).remove();
							});
                            success = true;
                        }
                    },
                    complete: function(){
                        c.removeLog();
                    },
                    error: function(jqXHR, textStatus, errorThrown){
                        c.showMessage("#btss-message", "Sending ajax request is failed. Check <b>ajax.php</b>, please.");
                        c.removeLog();
                    }
        
                })
               
            });
            if(!success){
                c.showMessage("#btss-message", "<b>Failed to delete images </b> - " + data.message);
            }else{
                c.showMessage("#btss-message", "<b>Deleted images successfully</b>");
            }
            c.removeLog();

            
        }
        this.showMessage = function(a,d){
            var a=$(a);
            var c=$('<div>').addClass('bt-message');
            c.html(d);
            c.hide();
            a.append(c);
			c.fadeIn();
        }
        this.removeLog = function(){
			setTimeout(function(){
				$("#btss-message").find(".bt-message").each(function(){
					var a = $(this);
					a.fadeOut(1000, function(){$(this).remove()});
					
				})
			}, 1000);	
        }
		
		this.initialize();
		return this;
    }
})(jQuery);